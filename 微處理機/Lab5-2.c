//
// LCD: display Text on LCD
//
// EVB : Nu-LB-NUC140
// MCU : NUC140VE3CN  (LQPF-100)
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "Scankey.h"
#include "LCD.h"

#define border 64
#define rowSize border
#define pageSize (border /8)
#define arrSize (rowSize*pageSize)

unsigned char curr[arrSize], next[arrSize];

unsigned char kirby [512] = {
		0x00,0x00,0x00,0x00,0xC0,0x30,0x08,0x04,0x02,0x02,0x01,0x01,0x01,0x01,0x01,0x02,0x04,0x0C,0xB0,0x40,0x40,0x40,0x20,0x20,0x20,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x20,0x20,0x20,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x01,0x00,0x00,0x00,0x80,0x60,0x20,0x20,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x10,0x10,0x30,0xE0,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x02,0x04,0x08,0x18,0x28,0xC8,0x08,0x08,0x08,0x08,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x03,0x1E,0x70,0x80,0x00,0xF0,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFC,0xF8,0xF8,0xFC,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFC,0xFC,0xFC,0xFF,0x7F,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0xC0,0x3F,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x14,0x0A,0x14,0x0A,0x04,0x00,0x01,0x03,0x07,0x03,0x01,0x30,0x48,0x88,0x08,0x08,0x88,0x78,0x01,0x03,0x03,0x01,0x00,0x00,0x02,0x05,0x02,0x05,0x0A,0x85,0x82,0x80,0x80,0xC0,0xC0,0xC0,0xF0,0xBF,0x08,0x0C,0x06,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0E,0x30,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,0xC0,0xE0,0xF0,0xF8,0xFC,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0xFC,0xF8,0xF0,0xE0,0xE0,0xC0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x1F,0x0F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xFE,0xFE,0xFE,0xFF,0x07,0x1F,0x1F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x1F,0x1F,0x0F,0x0F,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x07,0x0F,0x1F,0x3F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0x7F,0x7F,0x3F,0x1F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
unsigned char bandee [512] = {
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0xE0,0xE0,0xF0,0xF4,0xF4,0xF6,0xF7,0xF7,0xEF,0xE0,0xE0,0xE0,0xE0,0xC0,0xC0,0xBC,0xBF,0x7F,0xFF,0xF7,0x0F,0xFF,0xFE,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xF8,0x06,0xF1,0x0F,0x83,0x00,0x00,0xEF,0x18,0x00,0x00,0x00,0x00,0xF0,0x1C,0x04,0x02,0x02,0x82,0xBA,0xFE,0xFF,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0x7D,0x7B,0x7B,0x60,0xB0,0xB0,0x70,0x70,0xE0,0xE0,0xC0,0x80,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x03,0x0F,0x3C,0xE7,0xFC,0x40,0x7F,0x60,0xE0,0xF0,0xF8,0xFC,0x7F,0x1F,0x8E,0xC6,0x22,0x19,0x06,0x81,0xF1,0xFC,0xE2,0x63,0x1F,0x03,0x03,0x03,0xE7,0x17,0x0F,0x9F,0x7F,0x0F,0x1F,0x7F,0x9F,0x1F,0x1F,0x1F,0x7F,0x0F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC3,0x7F,0x3E,0x3F,0x3F,0x3F,0x3F,0x3E,0x18,
		0x00,0x00,0x00,0xC0,0x30,0x8C,0x42,0x22,0x13,0x0A,0x06,0x8C,0x98,0x68,0x07,0x03,0x1F,0xE0,0x0E,0x31,0x40,0x85,0x0A,0x04,0x01,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0x1F,0x1F,0x9F,0x47,0x81,0x40,0x80,0x80,0x40,0x47,0x4C,0x70,0x20,0x20,0x6C,0xD0,0x90,0xE0,0x20,0x10,0x18,0x08,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x0C,0x07,0x06,0x05,0x04,0x06,0x02,0x03,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x7C,0x88,0x11,0x22,0x42,0x44,0x88,0x88,0x10,0x10,0x20,0x20,0xE0,0x30,0x08,0x05,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xC1,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x18,0x60,0x80,0x00,0x00,0x00,0x01,0x01,0x01,0x02,0x02,0x87,0x6C,0x38,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x08,0x08,0x04,0x04,0x02,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x02,0x02,0x02,0x02,0x02,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

volatile int KEY_Flag = -1;
volatile int keyPressed = 0;
volatile int isNegative, i, j;
volatile int INT1_flag = 0;

void EINT1_IRQHandler(void)
{
    GPIO_CLR_INT_FLAG(PB, BIT15);  // Clear GPIO interrupt flag
		//if(INT1_flag == 0) INT1_flag = 1;
		KEY_Flag = 0;
}

void GPAB_IRQHandler(void)
{
	if (PA->ISRC & BIT0) {
		PA->ISRC |= BIT0;		// clear interupt state;
		keyPressed = ScanKey();
		switch (keyPressed) {
			case 3: KEY_Flag=3; break;
			case 6: KEY_Flag=6; break;
			case 9: KEY_Flag=9; break;
		}
	} else if (PA->ISRC & BIT1) {
		PA->ISRC |= BIT1;
		keyPressed = ScanKey();
		switch (keyPressed) {
			case 2: KEY_Flag=2; break;
			case 5: KEY_Flag=5; break;
			case 8: KEY_Flag=8; break;
		}
	} else if (PA->ISRC & BIT2) {
		PA->ISRC |= BIT2;
		keyPressed = ScanKey();
		switch (keyPressed) {
			case 1: KEY_Flag=1; break;
			case 4: KEY_Flag=4; break;
			case 7: KEY_Flag=7; break;
		}
	} else {
		PA->ISRC = PA->ISRC;	// clear all GPA pins
	}
	
	PA0 = PA1  = PA2 = 1;
	PA3 = PA4  = PA5 = 0;
}

void Init_GPIO()
{
	init_LCD();
	clear_LCD();
	// PA 0-2 & 3-5: keypad
	OpenKeyPad();
	// enable Interupt
  GPIO_EnableInt(PA, 0, GPIO_INT_FALLING);
	GPIO_EnableInt(PA, 1, GPIO_INT_FALLING);
	GPIO_EnableInt(PA, 2, GPIO_INT_FALLING);
	NVIC_EnableIRQ(GPAB_IRQn);
	// debounce keypad	
	GPIO_SET_DEBOUNCE_TIME(GPIO_DBCLKSRC_LIRC, GPIO_DBCLKSEL_64);
	GPIO_ENABLE_DEBOUNCE(PA, (BIT0 | BIT1 | BIT2));	
	
	PA0 = PA1  = PA2 = 1;
	PA3 = PA4  = PA5 = 0;
	
	GPIO_SetMode(PB, BIT15, GPIO_MODE_INPUT);
	GPIO_EnableEINT1(PB, 15, GPIO_INT_RISING); // RISING, FALLING, BOTH_EDGE, HIGH, LOW
	NVIC_EnableIRQ(EINT1_IRQn);
	
	GPIO_SET_DEBOUNCE_TIME(GPIO_DBCLKSRC_LIRC, GPIO_DBCLKSEL_64);
	GPIO_ENABLE_DEBOUNCE(PB, BIT15);
}

void resetImage(unsigned pic) {
    int i;
    for(i=0; i<arrSize; i++) curr[i] = pic ? kirby[i] : bandee[i];
}

void clearCurr() {
    int i;
    for(i=0; i<arrSize; i++) curr[i] = 0x00;
}

void clearNext() {
    int i;
    for(i=0; i<arrSize; i++) next[i] = 0x00;
}

void overwriteCurr() {
    int i;
    for(i=0; i<arrSize; i++) curr[i] = next[i];
}

void printCurr() {
    clear_LCD();
    draw_Bmp64x64(32,0,FG_COLOR, BG_COLOR, curr);
}

void horMirror() {
    int i,j,k;
    clearNext();
		for(i=0; i<pageSize; i++) for(j=0; j<8; j++) for(k=0; k<rowSize; k++) {
        next[i*rowSize+k] |= ((curr[i*rowSize+(rowSize-1-k)] & (1 << j)) || 0) << j;
    }
    overwriteCurr();
}

void verMirror() {
    int i,j,k;
    clearNext();
    for(i=0; i<pageSize; i++) for(j=0; j<8; j++) for(k=0; k<rowSize; k++) {
        next[i*rowSize+k] |= ((curr[(pageSize-1-i)*rowSize+k] & (1 << (8-1-j))) || 0) << j;
    }
    overwriteCurr();
}

void r90Rotate() {
    int i,j,k;
    clearNext();
    for(i=0; i<pageSize; i++) for(j=0; j<8; j++) for(k=0; k<rowSize; k++) {
        next[i*rowSize+k] |= ((curr[i*8+j+(pageSize-1-k/8)*rowSize] & (1 << (8-1-(k%8)))) || 0) << j;
    }
    overwriteCurr();
}

void l90Rotate() {
    int i,j,k;
    clearNext();
    for(i=0; i<pageSize; i++) for(j=0; j<8; j++) for(k=0; k<rowSize; k++) {
        next[i*rowSize+k] |= ((curr[rowSize-1-i*8-j+k/8*rowSize] & (1 << k%8)) || 0) << j;
    }
    overwriteCurr();
}

int main(void) {
  unsigned pic = 1;
	SYS_Init();
	Init_GPIO();
  resetImage(pic);
	clear_LCD();
	printCurr();

	while(1) {
			if (KEY_Flag == -1) continue;

			if (KEY_Flag == 5) {
					pic = !pic;
					resetImage(pic);
			}
			else if (KEY_Flag == 0) resetImage(pic);
			else if (KEY_Flag == 2) verMirror();
			else if (KEY_Flag == 4) horMirror();
			else if (KEY_Flag == 6) r90Rotate();
			else if (KEY_Flag == 8) l90Rotate();  
			else {
				KEY_Flag = -1;
				continue;
			}
			printCurr();
			KEY_Flag = -1;
	}
}
